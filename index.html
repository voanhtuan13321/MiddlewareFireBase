<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Firebase</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous" />
        <link rel="stylesheet" href="./css/style.css" />
    </head>
    <body>
        <div class="app">
            <div class="container">
                <h1 class="text-center text-info mt-5 mb-5">Database realtime</h1>
                <h4 class="text-center text-secondary" id="show-time">thoi gian</h4>
            </div>
            <div class="container mt-5">
                <div class="row">
                    
                    <div class="col-sm-12 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-success">
                                <tr>
                                    <th class="text-center rounded text-white" scope="col" colspan="2">Tempt</th>
                                </tr>
                            </thead>
                            <tbody id="content-temp">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>


                </div>
            </div>
        </div>

        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-analytics.js";
            import { getDatabase, set, get, update, remove, ref, child }
                from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyB0xHDIIKLH2PKzAY_JvP-xmk6iX3ti2D4",
                authDomain: "tuananh-5edf4.firebaseapp.com",
                databaseURL: "https://tuananh-5edf4-default-rtdb.firebaseio.com",
                projectId: "tuananh-5edf4",
                storageBucket: "tuananh-5edf4.appspot.com",
                messagingSenderId: "1083002744164",
                appId: "1:1083002744164:web:29b897f63d2b667d451e71",
                measurementId: "G-3BD800L1X4",
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getDatabase();

            const pathTemp = 'temp';
            const pathHum = 'hum';
            const pathSsCO2 = 'ssCO2';
            const pathDustDensity = 'dustDensity';
            const pathVotage = 'Votage';
            const pathCurrent = 'Current';
            const pathPower = 'Power';
            
            const elementShowTime = $('#show-time');
            const elementContentTemp = $('#content-temp');
            
            let phutQuaKhu = new Date().getMinutes();

            // inser data to firebase
            const insertData = (path, data) => {
                set(ref(db, path), data)
                    .then(() => console.log("sussefully"))
                    .catch((error) => console.error("faild:", error));
            };

            // get data from firebase
            const selectData = (path, key, callBack) => {
                const dbref = ref(db);
                get(child(dbref, path)).then((snapshot) => {
                    if (snapshot.exists()) {
                        callBack(snapshot.val());
                    } else {
                        const data = {};
                        data[key] = key;
                        insertData(path, data);
                    }
                });
            };

            // delete data to firebase
            // const deleteData = (data) => {
            //     remove(ref(db, "people/tuan"))
            //         .then(() => console.log("sussefully"))
            //         .catch((error) => console.error("faild:", error));
            // };

            // update data to firebase
            // const updateData = () => {
            //     update(ref(db, "people/tuan"), {
            //         name: data,
            //     })
            //         .then(() => console.log("sussefully"))
            //         .catch((error) => console.error("faild:", error));
            // };

            const renderTable = (elementContent, object) => {
                let keys = Object.keys(object);
                let htmls = '';
                for (const key of keys) {
                    htmls += `
                        <tr>
                            <td>${key}</td>
                            <td>${object[key]}</td>
                        </tr>
                    `;
                }
                elementContent.html(htmls);
            }

            // loop
            setInterval(() => {
                const today = new Date();
                const gioHienTai = today.getHours();
                const phutHienTai = today.getMinutes();
                const giayHienTai = today.getSeconds();
                const timeNow = `${gioHienTai < 10 ? '0' + gioHienTai : gioHienTai}:${phutHienTai < 10 ? '0' + phutHienTai : phutHienTai}`;
                
                elementShowTime.text(`Thời gian:
                    ${gioHienTai < 10 ? '0' + gioHienTai : gioHienTai} giờ
                    ${phutHienTai < 10 ? '0' + phutHienTai : phutHienTai} phút
                    ${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai} giây`);

                // temp
                selectData(pathTemp, timeNow, (value) => {
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai} giây`;
                    insertData(pathTemp, value);
                    if (phutQuaKhu !== phutHienTai) {
                        value[timeNow] = value.now;
                        insertData(pathTemp, value);
                        phutQuaKhu = phutHienTai;
                    }
                    renderTable(elementContentTemp, value);
                });
                
            }, 1000);

        </script>
    </body>
</html>
