<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Firebase</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous" />
        <style>
            body {
                background-color: #e3e0bc;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <div class="container">
                <h1 class="text-center text-info mt-5 mb-5">Database realtime</h1>
                <h4 class="text-center text-secondary" id="show-time">thoi gian</h4>
            </div>
            <div class="container mt-5">
                <div class="row">
                    <!-- table tempt -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-success">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">Tempt</th></tr>
                            </thead>
                            <tbody id="content-temp">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table hum -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-primary">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">Hum</th></tr>
                            </thead>
                            <tbody id="content-hum">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table ssCO2 -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-secondary">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">ssCO2</th></tr>
                            </thead>
                            <tbody id="content-ssCO2">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table dustDensity -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-danger">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">DustDensity</th></tr>
                            </thead>
                            <tbody id="content-dustDensity">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table Votage -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-warning">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">Votage</th></tr>
                            </thead>
                            <tbody id="content-Votage">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table Current -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-info">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">Current</th></tr>
                            </thead>
                            <tbody id="content-Current">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- table Power -->
                    <div class="mb-3 col-sm-6 col-md-4 col-lg-3 col-xl-2">  
                        <table class="table bg-light rounded">
                            <thead class="bg-dark">
                                <tr><th class="text-center rounded text-white" scope="col" colspan="2">Power</th></tr>
                            </thead>
                            <tbody id="content-Power">
                                <tr>
                                    <td>Key</td>
                                    <td>Value</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"></script>
        <script type="module">
            // Import the functions you need from the SDKs you need
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-app.js";
            import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.14.0/firebase-analytics.js";
            import { getDatabase, set, get, update, remove, ref, child }
                from "https://www.gstatic.com/firebasejs/9.14.0/firebase-database.js";

            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyB0xHDIIKLH2PKzAY_JvP-xmk6iX3ti2D4",
                authDomain: "tuananh-5edf4.firebaseapp.com",
                databaseURL: "https://tuananh-5edf4-default-rtdb.firebaseio.com",
                projectId: "tuananh-5edf4",
                storageBucket: "tuananh-5edf4.appspot.com",
                messagingSenderId: "1083002744164",
                appId: "1:1083002744164:web:29b897f63d2b667d451e71",
                measurementId: "G-3BD800L1X4",
            };

            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const db = getDatabase();

            // create url to connect to Firebase
            const paths = {
                temp:'temp',
                hum:'hum',
                ssCO2:'ssCO2',
                dustDensity:'dustDensity',
                votage:'Votage',
                current:'Current',
                power:'Power',
            };
            
            // select cac element chua content
            const elementShowTime = $('#show-time');
            const elements = {
                temp: $('#content-temp'),
                hum: $('#content-hum'),
                ssCO2: $('#content-ssCO2'),
                dustDensity: $('#content-dustDensity'),
                votage: $('#content-Votage'),
                current: $('#content-Current'),
                power: $('#content-Power'),
            }

            // inser data to firebase
            const insertData = (path, data) => {
                set(ref(db, path), data)
                    .then(() => {})
                    .catch((error) => console.error("faild:", error));
            };

            // get data from firebase
            const selectData = (path, key, callBack) => {
                const dbref = ref(db);
                get(child(dbref, path))
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            // truong hop ton tai du lieu theo path, thi goi callBack truyen du lieu vao xu ly tiep
                            callBack(snapshot.val());
                        } else {
                            // truong hop khong ton tai, thi tao moi du lieu roi them moi
                            const data = {};
                            data[key] = key;
                            insertData(path, data);
                        }
                    })
                    .catch(error => console.error("faild:", error));
            };

            // delete data to firebase
            // const deleteData = (data) => {
            //     remove(ref(db, "people/tuan"))
            //         .then(() => console.log("sussefully"))
            //         .catch((error) => console.error("faild:", error));
            // };

            // update data to firebase
            // const updateData = () => {
            //     update(ref(db, "people/tuan"), {
            //         name: data,
            //     })
            //         .then(() => console.log("sussefully"))
            //         .catch((error) => console.error("faild:", error));
            // };

            /**
             * ham dung de render du lieu ra giao dien
             * @param elementShowTime: la element, noi chua giao dien can hien thi
             * @param object: la doi tuong chua du lieu
             */
            const renderTable = (elementContent, object) => {
                let keys = Object.keys(object);
                let htmls = '';

                for (const key of keys) {
                    htmls += `
                        <tr>
                            <td>${key}</td>
                            <td>${object[key]}</td>
                        </tr>
                    `;
                }

                elementContent.html(htmls);
            }

            /**
             * Loop
             * moi 1s lap 1 lan
             * lay now tu firebase, sau do kiem tra, cu moi phut cap nhat vao firebase voi gia tri cua now
             */
            setInterval(() => {
                const today = new Date();
                const gioHienTai = today.getHours();
                const phutHienTai = today.getMinutes();
                const giayHienTai = today.getSeconds();
                const timeNow = `${gioHienTai < 10 ? '0' + gioHienTai : gioHienTai}:${phutHienTai < 10 ? '0' + phutHienTai : phutHienTai}`;
                
                elementShowTime.text(`Thời gian:
                    ${gioHienTai < 10 ? '0' + gioHienTai : gioHienTai} giờ
                    ${phutHienTai < 10 ? '0' + phutHienTai : phutHienTai} phút
                    ${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai} giây`);

                // xu ly cho temp
                selectData(paths.temp, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.temp, value);
                    renderTable(elements.temp, value);
                });

                // xu ly cho hum
                selectData(paths.hum, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.hum, value);
                    renderTable(elements.hum, value);
                });

                // xu ly cho ssCO2
                selectData(paths.ssCO2, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.ssCO2, value);
                    renderTable(elements.ssCO2, value);
                });

                // xu ly cho dustDensity
                selectData(paths.dustDensity, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.dustDensity, value);
                    renderTable(elements.dustDensity, value);
                });

                // xu ly cho xu ly cho Votage
                selectData(paths.votage, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.votage, value);
                    renderTable(elements.votage, value);
                });

                // xu ly cho xu ly cho current
                selectData(paths.current, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.current, value);
                    renderTable(elements.current, value);
                });

                // xu ly cho xu ly cho power
                selectData(paths.power, timeNow, (value) => {
                    // gan tam gia tri cho key now
                    // doi khi nap co du lieu ben cam bien thi comment lai
                    value.now = timeNow + `:${giayHienTai < 10 ? '0' + giayHienTai : giayHienTai}`;

                    // cap nhat gia thi theo phutHienTai tu gia tri cua key now
                    value[timeNow] = value.now;
                    insertData(paths.power, value);
                    renderTable(elements.power, value);
                });
            }, 1000);
        </script>
    </body>
</html>
